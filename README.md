# Async api PoC

Эксперимент с реализацией bff с использованием асинхронных технологий

## Установка

Клонируем репозиторий и регистрируем воркспейс
```shell
git clone <>
cd async-api-poc

elc ws add example $PWD/workspace
elc ws select example
```

Запускаем скрипт инициализации. Он:
* копирует и заполняет env файлы
* создаёт БД для сервисов
* устанавливает зависимости
* запускает почти все севрисы

```shell
./workspace/scripts/init.sh
```

Инициализацию нужно выполнять один раз. Дальше долстаточно будет запускать сервисы

## Запуск сервисов

Сервисы api, basket и product можно запустить через elc. Эти сервисы автоматически запускаются при инициализации.
```shell
elc start api basket product
```

Сервис api-hyperf не имеет механизма релоада кода при изменениях, поэтому он не запускается автоматически. Его надо запускать вручную
```shell
elc -c api-hyperf bash
php bin/hyperf.php start
```
Если вы изменили код в этом сервисе, то его надо завершить нажав Ctrl+C и запустить заново.


## Запуск нагрузочных тестов

Переходим в папку load-test и выполняем настройку [по инструкции](./load-test/README.md)  
Запускаем тест для сервиса api
```shell
locust --headless --only-summary --host=http://api.example.127.0.0.1.nip.io/ --locustfile locustfiles/api.py
```

Запускаем тест для сервиса api-hyperf
```shell
locust --headless --only-summary --host=http://api-hyperf.example.127.0.0.1.nip.io/ --locustfile locustfiles/api.py
```

Переходим на список тестов http://127.0.0.1:3000/d/load-test-list/list-of-tests  
Новые тесты будут в низу списка. Могут появиться с задержкой в несколько секунд после старта теста.

Чтобы перейти в конкретный тест надо нажать на текст в первом столбце.  
Открыв тест полезно выбрать автообновление раз в 5 секунд.  
Открыв завершённый тест надо нажать на кнопку с датой в самой первой панели. Это центрирует таймлайн на тесте.  

Метрики CPU/RAM по контейнерам можно найти на http://127.0.0.1:3000/d/9AJV_mnIk/cadvisor-dashboard
